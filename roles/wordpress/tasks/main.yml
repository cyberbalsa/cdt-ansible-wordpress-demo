---
# =============================================================================
# WordPress Application Server Setup
# =============================================================================
# This role installs WordPress with PHP on the application server.
#
# After completing this role, you will have:
# - PHP and required extensions installed
# - WordPress downloaded and configured
# - WordPress connected to the MySQL database from Session 1
#
# TIP: Look at the completed MySQL role (roles/mysql/tasks/main.yml)
# for examples of the apt, service, and other modules in action!
#
# VARIABLES AVAILABLE TO YOU (defined in group_vars/all.yml):
# - {{ wordpress_db_name }}       - Database name (e.g., "wordpress")
# - {{ wordpress_db_user }}       - Database username
# - {{ wordpress_db_password }}   - Database password
# - {{ database_server }}         - IP of the MySQL server
# - {{ wordpress_install_dir }}   - Where to install WordPress
# - {{ wordpress_download_url }}  - URL to download WordPress archive
# - {{ php_packages }}            - List of PHP packages to install
# =============================================================================


# -----------------------------------------------------------------------------
# TASK 1: Install PHP and Required Extensions
# -----------------------------------------------------------------------------
# WordPress is written in PHP, so we need to install PHP and its extensions.
# We'll install multiple packages at once using a list variable.
#
# This is just like "Install MySQL server" in the MySQL role, but instead
# of a single package name, we pass a list variable. The apt module handles
# both single names and lists!
#
# HINT: Use the 'apt' module
# - name: "{{ php_packages }}" (this is a list defined in group_vars)
# - state: present
# - update_cache: true
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html

- name: Install PHP and extensions
  # ╔════════════════════════════════════════════════════════════════════════╗
  # ║ STUDENT TODO: Replace the fail module below with apt module            ║
  # ║                                                                         ║
  # ║ Example format:                                                         ║
  # ║   ansible.builtin.apt:                                                  ║
  # ║     name: "{{ php_packages }}"                                          ║
  # ║     state: present                                                      ║
  # ║     update_cache: true                                                  ║
  # ╚════════════════════════════════════════════════════════════════════════╝
  ansible.builtin.fail:
    msg: "STUDENT TODO: Replace this fail module with the apt module to install php_packages"


# -----------------------------------------------------------------------------
# TASK 2: Create WordPress installation directory (DONE FOR YOU)
# -----------------------------------------------------------------------------
# We need a directory to put WordPress files in.
# This is done for you as an example of the 'file' module with state: directory.

- name: Create WordPress directory
  ansible.builtin.file:
    path: "{{ wordpress_install_dir }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'


# -----------------------------------------------------------------------------
# TASK 3: Download WordPress
# -----------------------------------------------------------------------------
# Download the latest WordPress archive from wordpress.org.
# This is a NEW module you haven't used yet: get_url downloads files
# from the internet to a path on the remote server.
#
# HINT: Use the 'get_url' module
# - url: "{{ wordpress_download_url }}"
# - dest: /tmp/wordpress.tar.gz
# - mode: '0644'
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html

- name: Download WordPress
  # ╔════════════════════════════════════════════════════════════════════════╗
  # ║ STUDENT TODO: Replace the fail module below with get_url module        ║
  # ║                                                                         ║
  # ║ Example format:                                                         ║
  # ║   ansible.builtin.get_url:                                              ║
  # ║     url: "{{ wordpress_download_url }}"                                 ║
  # ║     dest: /tmp/wordpress.tar.gz                                         ║
  # ║     mode: '0644'                                                        ║
  # ╚════════════════════════════════════════════════════════════════════════╝
  ansible.builtin.fail:
    msg: "STUDENT TODO: Replace this fail module with the get_url module"


# -----------------------------------------------------------------------------
# TASK 4: Extract WordPress
# -----------------------------------------------------------------------------
# Unpack the downloaded .tar.gz archive into our installation directory.
# Another NEW module: unarchive extracts compressed archives.
#
# HINT: Use the 'unarchive' module
# - src: /tmp/wordpress.tar.gz
# - dest: "{{ wordpress_install_dir }}"
# - remote_src: true (the archive is already on the server, not our laptop)
# - extra_opts: ["--strip-components=1"] (removes the wordpress/ folder layer
#   so files land directly in wordpress_install_dir instead of a subfolder)
#
# BONUS: Add creates: "{{ wordpress_install_dir }}/wp-settings.php"
#   to skip extraction if WordPress is already there (idempotency!)
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/unarchive_module.html

- name: Extract WordPress
  # ╔════════════════════════════════════════════════════════════════════════╗
  # ║ STUDENT TODO: Replace the fail module below with unarchive module      ║
  # ║                                                                         ║
  # ║ Example format:                                                         ║
  # ║   ansible.builtin.unarchive:                                            ║
  # ║     src: /tmp/wordpress.tar.gz                                          ║
  # ║     dest: "{{ wordpress_install_dir }}"                                 ║
  # ║     remote_src: true                                                    ║
  # ║     extra_opts: ["--strip-components=1"]                                ║
  # ╚════════════════════════════════════════════════════════════════════════╝
  ansible.builtin.fail:
    msg: "STUDENT TODO: Replace this fail module with the unarchive module"


# -----------------------------------------------------------------------------
# TASK 5: Configure WordPress (wp-config.php)
# -----------------------------------------------------------------------------
# WordPress needs a config file to know how to connect to the database.
# We use a TEMPLATE — Ansible reads the .j2 file, fills in our variables
# (database name, user, password, host), and copies the result to the server.
#
# Look at templates/wp-config.php.j2 to see the {{ variables }} inside!
#
# HINT: Use the 'template' module
# - src: wp-config.php.j2 (Ansible looks in this role's templates/ folder)
# - dest: "{{ wordpress_install_dir }}/wp-config.php"
# - owner: www-data
# - group: www-data
# - mode: '0640'  (restrictive permissions — this file contains passwords!)
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html

- name: Configure WordPress
  # ╔════════════════════════════════════════════════════════════════════════╗
  # ║ STUDENT TODO: Replace the fail module below with template module       ║
  # ║                                                                         ║
  # ║ Example format:                                                         ║
  # ║   ansible.builtin.template:                                             ║
  # ║     src: wp-config.php.j2                                               ║
  # ║     dest: "{{ wordpress_install_dir }}/wp-config.php"                   ║
  # ║     owner: www-data                                                     ║
  # ║     group: www-data                                                     ║
  # ║     mode: '0640'                                                        ║
  # ╚════════════════════════════════════════════════════════════════════════╝
  ansible.builtin.fail:
    msg: "STUDENT TODO: Replace this fail module with the template module"


# -----------------------------------------------------------------------------
# TASK 6: Set WordPress file ownership
# -----------------------------------------------------------------------------
# The web server process runs as the 'www-data' user. It needs to own
# the WordPress files so PHP can read (and sometimes write) them.
#
# This uses the same 'file' module from Task 2, but with recurse: true
# to apply ownership to ALL files and subdirectories inside.
#
# HINT: Use the 'file' module with recurse
# - path: "{{ wordpress_install_dir }}"
# - owner: www-data
# - group: www-data
# - recurse: true
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html

- name: Set WordPress file ownership
  # ╔════════════════════════════════════════════════════════════════════════╗
  # ║ STUDENT TODO: Replace the fail module below with file module           ║
  # ║                                                                         ║
  # ║ Example format:                                                         ║
  # ║   ansible.builtin.file:                                                 ║
  # ║     path: "{{ wordpress_install_dir }}"                                 ║
  # ║     owner: www-data                                                     ║
  # ║     group: www-data                                                     ║
  # ║     recurse: true                                                       ║
  # ╚════════════════════════════════════════════════════════════════════════╝
  ansible.builtin.fail:
    msg: "STUDENT TODO: Replace this fail module with the file module"


# -----------------------------------------------------------------------------
# TASK 7-8: Configure PHP-FPM (DONE FOR YOU)
# -----------------------------------------------------------------------------
# PHP-FPM processes PHP code for WordPress. By default it listens on a
# local socket, but we need it on TCP port 9000 so the Nginx server
# (a different machine) can send requests to it over the network.
#
# These tasks are done for you — they use the lineinfile and service
# modules you've already seen in the MySQL role.

- name: Configure PHP-FPM to listen on all interfaces
  ansible.builtin.lineinfile:
    path: /etc/php/8.3/fpm/pool.d/www.conf
    regexp: '^listen = '
    line: 'listen = 0.0.0.0:9000'
  notify: Restart PHP-FPM

- name: Ensure PHP-FPM is running
  ansible.builtin.service:
    name: php8.3-fpm
    state: started
    enabled: true
